#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FLL Telegram Bot
# –ê–≤—Ç–æ—Ä: Assistant
# –î–∞—Ç–∞: $(date)

echo "üöÄ –ó–∞–ø—É—Å–∫ FLL Telegram Bot..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ ! -d "venv" ]; then
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–æ–∑–¥–∞—ë–º..."
    python3 -m venv venv
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source venv/bin/activate

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ -f "scripts/requirements.txt" ]; then
    echo "üìã –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª requirements.txt, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install -r scripts/requirements.txt
else
    echo "üì¶ –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é..."
    pip install aiogram>=3.0.0
    pip install sqlalchemy>=2.0.0
    pip install aiosqlite>=0.19.0
    pip install pandas>=2.0.0
    pip install openpyxl>=3.1.0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç
if screen -list | grep -q "fll_bot"; then
    echo "‚ö†Ô∏è  –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ screen —Å–µ—Å—Å–∏–∏ 'fll_bot'"
    echo "üì± –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Å—Å–∏–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: screen -r fll_bot"
    echo "üîÑ –î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: screen -X -S fll_bot quit"
    exit 1
fi

# –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é screen —Å–µ—Å—Å–∏—é –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üé¨ –°–æ–∑–¥–∞–Ω–∏–µ screen —Å–µ—Å—Å–∏–∏ 'fll_bot'..."
screen -dmS fll_bot bash -c "source venv/bin/activate && python3 main.py"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–ª–∞—Å—å
sleep 2
if screen -list | grep -q "fll_bot"; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ screen —Å–µ—Å—Å–∏–∏ 'fll_bot'"
    echo ""
    echo "üì± –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "   –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Å—Å–∏–∏: screen -r fll_bot"
    echo "   –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç —Å–µ—Å—Å–∏–∏: Ctrl+A, –∑–∞—Ç–µ–º D"
    echo "   –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞: screen -X -S fll_bot quit"
    echo "   –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π: screen -list"
    echo ""
    echo "üîó –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç SSH!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ screen —Å–µ—Å—Å–∏–∏"
    exit 1
fi 